---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.16.4
  name: metalstackclusters.infrastructure.cluster.x-k8s.io
spec:
  group: infrastructure.cluster.x-k8s.io
  names:
    kind: MetalStackCluster
    listKind: MetalStackClusterList
    plural: metalstackclusters
    singular: metalstackcluster
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - description: Cluster to which this MetalStackCluster belongs
      jsonPath: .metadata.labels.cluster\.x-k8s\.io/cluster-name
      name: Cluster
      type: string
    - description: Control plane API endpoint
      jsonPath: .spec.controlPlaneEndpoint.host
      name: Endpoint
      type: string
    - description: The partition within metal-stack
      jsonPath: .spec.partition
      name: Partition
      priority: 1
      type: string
    - description: The project within metal-stack
      jsonPath: .spec.projectID
      name: Project
      priority: 1
      type: string
    - description: The network within metal-stack
      jsonPath: .spec.nodeNetworkID
      name: Network
      priority: 1
      type: string
    - description: MetalStackCluster is ready
      jsonPath: .status.ready
      name: Ready
      type: string
    - description: Uptime of the cluster
      jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: MetalStackCluster is the Schema for the metalstackclusters API.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: MetalStackClusterSpec defines the desired state of MetalStackCluster.
            properties:
              controlPlaneEndpoint:
                description: ControlPlaneEndpoint represents the endpoint used to
                  communicate with the control plane.
                properties:
                  host:
                    description: Host is the hostname on which the API server is serving.
                    type: string
                  port:
                    description: Port is the port on which the API server is serving.
                    type: integer
                required:
                - host
                - port
                type: object
              controlPlaneIP:
                description: |-
                  ControlPlaneIP is the ip address in metal-stack on which the control plane will be exposed.
                  If this ip and the control plane endpoint are not provided, an ephemeral ip will automatically be acquired during reconcile.
                  Static ip addresses will not be deleted.
                type: string
              firewallDeploymentSpec:
                description: FirewallDeploymentSpec defines the firewall deployment
                  template spec used to create firewalls for the cluster.
                properties:
                  autoUpdate:
                    description: AutoUpdate defines the behavior for automatic updates.
                    properties:
                      machineImage:
                        description: |-
                          MachineImage auto updates the os image of the firewall within the maintenance time window
                          in case a newer version of the os is available.
                        type: boolean
                    required:
                    - machineImage
                    type: object
                  replicas:
                    description: |-
                      Replicas is the amount of firewall replicas targeted to be running.
                      Defaults to 1.
                    type: integer
                  selector:
                    additionalProperties:
                      type: string
                    description: |-
                      Selector is a label query over firewalls that should match the replicas count.
                      If selector is empty, it is defaulted to the labels present on the firewall template.
                      Label keys and values that must match in order to be controlled by this replication
                      controller, if empty defaulted to labels on firewall template.
                    type: object
                  strategy:
                    description: |-
                      Strategy describes the strategy how firewalls are updated in case the update requires a physical recreation of the firewalls.
                      Defaults to RollingUpdate strategy.
                    type: string
                  template:
                    description: Template is the firewall spec used for creating the
                      firewalls.
                    properties:
                      metadata:
                        description: Metadata of the firewalls created from this template.
                        type: object
                      spec:
                        description: Spec contains the firewall specification.
                        properties:
                          allowedNetworks:
                            description: |-
                              AllowedNetworks defines dedicated networks for which the firewall allows in- and outgoing traffic.
                              The firewall-controller only enforces this setting in combination with NetworkAccessType set to forbidden.
                              The node network is always allowed.
                            properties:
                              egress:
                                description: Egress defines a list of cidrs which
                                  are allowed for outgoing traffic.
                                items:
                                  type: string
                                type: array
                              ingress:
                                description: Ingress defines a list of cidrs which
                                  are allowed for incoming traffic like service type
                                  loadbalancer.
                                items:
                                  type: string
                                type: array
                            type: object
                          controllerURL:
                            description: ControllerURL points to the downloadable
                              binary artifact of the firewall controller.
                            type: string
                          controllerVersion:
                            description: ControllerVersion holds the firewall-controller
                              version to reconcile.
                            type: string
                          dnsPort:
                            description: DNSPort specifies port to which DNS proxy
                              should be bound
                            type: integer
                          dnsServerAddress:
                            description: DNSServerAddress specifies DNS server address
                              used by DNS proxy
                            type: string
                          dryRun:
                            description: DryRun if set to true, firewall rules are
                              not applied. For devel-purposes only.
                            type: boolean
                          egressRules:
                            description: EgressRules contains egress rules configured
                              for this firewall.
                            items:
                              description: EgressRuleSNAT holds a Source-NAT rule
                              properties:
                                ips:
                                  description: IPs contains the ips used as source
                                    addresses for packets leaving the specified network.
                                  items:
                                    type: string
                                  type: array
                                networkID:
                                  description: NetworkID is the network for which
                                    the egress rule will be configured.
                                  type: string
                              required:
                              - ips
                              - networkID
                              type: object
                            type: array
                          image:
                            description: |-
                              Image is the os image of the firewall.
                              An update on this field requires the recreation of the physical firewall and can therefore lead to traffic interruption for the cluster.
                            type: string
                          initialRuleSet:
                            description: InitialRuleSet is the initial firewall ruleset
                              applied before the firewall-controller starts running.
                            properties:
                              egress:
                                description: Egress rules to be deployed initially
                                  on the firewall.
                                items:
                                  properties:
                                    comment:
                                      description: Comment provides a human readable
                                        description of this rule.
                                      type: string
                                    ports:
                                      description: Ports contains all affected network
                                        ports.
                                      items:
                                        format: int32
                                        type: integer
                                      type: array
                                    protocol:
                                      description: Protocol constraints the protocol
                                        this rule applies to.
                                      type: string
                                    to:
                                      description: To source address cidrs this rule
                                        applies to.
                                      items:
                                        type: string
                                      type: array
                                  required:
                                  - ports
                                  - protocol
                                  - to
                                  type: object
                                type: array
                              ingress:
                                description: Ingress rules to be deployed initially
                                  on the firewall.
                                items:
                                  properties:
                                    comment:
                                      description: Comment provides a human readable
                                        description of this rule.
                                      type: string
                                    from:
                                      description: From source address cidrs this
                                        rule applies to.
                                      items:
                                        type: string
                                      type: array
                                    ports:
                                      description: Ports contains all affected network
                                        ports.
                                      items:
                                        format: int32
                                        type: integer
                                      type: array
                                    protocol:
                                      description: Protocol constraints the protocol
                                        this rule applies to.
                                      type: string
                                  required:
                                  - from
                                  - ports
                                  - protocol
                                  type: object
                                type: array
                            type: object
                          internalPrefixes:
                            description: |-
                              InternalPrefixes specify prefixes which are considered local to the partition or all regions. This is used for the traffic counters.
                              Traffic to/from these prefixes is counted as internal traffic.
                            items:
                              type: string
                            type: array
                          interval:
                            description: Interval on which rule reconciliation by
                              the firewall-controller should happen.
                            type: string
                          ipv4RuleFile:
                            description: Ipv4RuleFile defines where to store the generated
                              ipv4 firewall rules on disk.
                            type: string
                          logAcceptedConnections:
                            description: LogAcceptedConnections if set to true, also
                              log accepted connections in the droptailer log.
                            type: boolean
                          networks:
                            description: |-
                              Networks are the networks to which this firewall is connected.
                              An update on this field requires the recreation of the physical firewall and can therefore lead to traffic interruption for the cluster.
                              Detailed information about the networks are fetched continuously during runtime and stored in the status.firewallNetworks.
                            items:
                              type: string
                            type: array
                          nftablesExporterURL:
                            description: NftablesExporterURL points to the downloadable
                              binary artifact of the nftables exporter.
                            type: string
                          nftablesExporterVersion:
                            description: NftablesExporterVersion holds the nftables
                              exporter version to reconcile.
                            type: string
                          partition:
                            description: Partition is the partition in which the firewall
                              resides.
                            type: string
                          project:
                            description: Project is the project in which the firewall
                              resides.
                            type: string
                          rateLimits:
                            description: RateLimits allows configuration of rate limit
                              rules for interfaces.
                            items:
                              description: RateLimit contains the rate limit rule
                                for a network.
                              properties:
                                networkID:
                                  description: NetworkID specifies the network which
                                    should be rate limited.
                                  type: string
                                rate:
                                  description: Rate is the input rate in MiB/s.
                                  format: int32
                                  type: integer
                              required:
                              - networkID
                              - rate
                              type: object
                            type: array
                          size:
                            description: |-
                              Size is the machine size of the firewall.
                              An update on this field requires the recreation of the physical firewall and can therefore lead to traffic interruption for the cluster.
                            type: string
                          sshPublicKeys:
                            description: |-
                              SSHPublicKeys are public keys which are added to the firewall's authorized keys file on creation.
                              It gets defaulted to the public key of ssh secret as provided by the controller flags.
                            items:
                              type: string
                            type: array
                          userdata:
                            description: |-
                              Userdata contains the userdata used for the creation of the firewall.
                              It gets defaulted to a userdata matching for the firewall-controller with connection to Gardener shoot and seed.
                            type: string
                          userdataContents:
                            description: |-
                              UserdataContents contains the unprocessed userdata as separate files.
                              This is meant as an alternative to `Userdata`.
                            items:
                              description: UserdataContent represents a file at a
                                specific path with either direct content or content
                                sourced from a secret or configmap.
                              properties:
                                content:
                                  description: Content is the direct content of the
                                    file.
                                  type: string
                                contentFrom:
                                  description: ContentFrom represents the source from
                                    which to obtain the content of the file.
                                  properties:
                                    configMapKeyRef:
                                      description: ConfigMapKeyRef is a reference
                                        to a key within a configmap.
                                      properties:
                                        key:
                                          description: Key is the key within the configmap.
                                          type: string
                                        name:
                                          description: Name is the name of the configmap.
                                          type: string
                                      required:
                                      - key
                                      - name
                                      type: object
                                    firewallControllerKubeconfigSecret:
                                      description: FirewallControllerKubeconfigSecret
                                        is a reference to the desired kubeconfig secret
                                        for the firewall-controller to access the
                                        seed cluster. This kubeconfig will be generated
                                        by the firewall-controller-manager.
                                      properties:
                                        key:
                                          description: Key is the key within the secret.
                                          type: string
                                        name:
                                          description: Name is the name of the secret.
                                          type: string
                                      required:
                                      - key
                                      - name
                                      type: object
                                    secretKeyRef:
                                      description: SecretKeyRef is a reference to
                                        a key within a secret.
                                      properties:
                                        key:
                                          description: Key is the key within the secret.
                                          type: string
                                        name:
                                          description: Name is the name of the secret.
                                          type: string
                                      required:
                                      - key
                                      - name
                                      type: object
                                  required:
                                  - configMapKeyRef
                                  - secretKeyRef
                                  type: object
                                path:
                                  description: Path is the file path where the content
                                    should be placed.
                                  type: string
                              required:
                              - contentFrom
                              - path
                              type: object
                            type: array
                        required:
                        - image
                        - networks
                        - partition
                        - project
                        - size
                        type: object
                    type: object
                required:
                - autoUpdate
                - template
                type: object
              nodeNetworkID:
                description: NodeNetworkID is the network ID in metal-stack in which
                  the worker nodes and the firewall of the cluster are placed.
                type: string
              partition:
                description: Partition is the data center partition in which the resources
                  are created.
                type: string
              projectID:
                description: ProjectID is the project id of the project in metal-stack
                  in which the associated metal-stack resources are created.
                type: string
            required:
            - nodeNetworkID
            - partition
            - projectID
            type: object
          status:
            description: MetalStackClusterStatus defines the observed state of MetalStackCluster.
            properties:
              conditions:
                description: Conditions defines current service state of the MetalStackCluster.
                items:
                  description: Condition defines an observation of a Cluster API resource
                    operational state.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed. If that is not known, then using the time when
                        the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This field may be empty.
                      maxLength: 10240
                      minLength: 1
                      type: string
                    reason:
                      description: |-
                        reason is the reason for the condition's last transition in CamelCase.
                        The specific API may choose whether or not this field is considered a guaranteed API.
                        This field may be empty.
                      maxLength: 256
                      minLength: 1
                      type: string
                    severity:
                      description: |-
                        severity provides an explicit classification of Reason code, so the users or machines can immediately
                        understand the current situation and act accordingly.
                        The Severity field MUST be set only when Status=False.
                      maxLength: 32
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      type: string
                    type:
                      description: |-
                        type of condition in CamelCase or in foo.example.com/CamelCase.
                        Many .condition.type values are consistent across resources like Available, but because arbitrary conditions
                        can be useful (see .node.status.conditions), the ability to deconflict is important.
                      maxLength: 256
                      minLength: 1
                      type: string
                  required:
                  - lastTransitionTime
                  - status
                  - type
                  type: object
                type: array
              failureMessage:
                description: |-
                  FailureMessage indicates that there is a fatal problem reconciling the
                  state, and will be set to a descriptive error message.
                type: string
              failureReason:
                description: |-
                  FailureReason indicates that there is a fatal problem reconciling the
                  state, and will be set to a token value suitable for
                  programmatic interpretation.
                type: string
              ready:
                default: false
                description: Ready denotes that the cluster is ready.
                type: boolean
            required:
            - ready
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
